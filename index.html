<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simulador de Tarjeta de Crédito</title>
    <!-- Flatpickr CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <!-- Font Awesome para iconos -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body {
            font-family: 'Arial', sans-serif;
            background-color: #f4f4f9;
            margin: 0;
            padding: 0;
            color: #333;
        }

        .container {
            width: 80%;
            margin: 0 auto;
            background-color: white;
            padding: 20px;
            box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.1);
            margin-top: 30px;
            border-radius: 10px;
        }

        h1, h2 {
            text-align: center;
            color: #d9534f; /* Rojo */
        }

        form {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            margin-bottom: 20px;
        }

        .form-group {
            flex: 1 1 48%;
            margin-bottom: 20px;
            width: 48%; /* Asegurar que el contenedor ocupe el mismo ancho que los demás campos */
        }

        .form-group-50 {
            flex: 1 1 48%;
            margin-bottom: 20px;
            width: 48%;
        }

        label {
            font-size: 1rem;
            color: #d9534f;
            display: block;
            margin-bottom: 5px;
        }

        input[type="number"],
        input[type="text"],
        input[type="date"],
        button {
            width: 100%;
            padding: 10px;
            margin-top: 5px;
            font-size: 1rem;
            border: 2px solid #d9534f; /* Borde rojo */
            border-radius: 10px; /* Bordes redondeados */
            box-sizing: border-box;
        }

        /* Estilos para el contenedor de cuotas */
        .cuotas-container {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            padding: 5px;
            border: 2px solid #d9534f;
            border-radius: 10px;
            min-height: 50px;
            cursor: text;
            width: 100%; /* Asegurar que el contenedor ocupe todo el ancho disponible */
            box-sizing: border-box; /* Asegurar que el padding y el borde no afecten el ancho total */
        }

        .cuotas-container input {
            border: none;
            outline: none;
            flex: 1;
            min-width: 100px;
            font-size: 1rem;
            padding: 5px;
            width: 100%; /* Añadir esto para asegurar que el campo de entrada ocupe todo el ancho disponible */
        }

        .cuota-tag {
            display: inline-flex;
            align-items: center;
            background-color: #d9534f;
            color: white;
            padding: 5px 10px;
            border-radius: 20px;
            margin: 5px;
            font-size: 0.9rem;
        }

        .cuota-tag .remove-tag {
            margin-left: 8px;
            cursor: pointer;
            font-weight: bold;
        }

        button {
            background-color: #d9534f; /* Rojo */
            color: white;
            cursor: pointer;
            border-radius: 10px;
            border: none;
            transition: background-color 0.3s ease;
        }

        button:hover {
            background-color: #c9302c; /* Rojo oscuro */
        }

        .button-container {
            display: flex;
            width: 100%;
            gap: 10px;
        }

        .button-container button {
            flex: 1;
        }

        .button-container button.limpiar {
            flex: 1; /* 25% del ancho */
            background-color: #f8d7da; /* Rojo claro */
            color: #d9534f; /* Rojo */
        }

        .button-container button.simular {
            flex: 3; /* 75% del ancho */
        }

        .simulation-container {
            margin-top: 30px;
            border-top: 2px solid #d9534f;
            padding-top: 20px;
        }

        .simulation {
            margin-bottom: 40px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }

        table th, table td {
            padding: 12px;
            border: 1px solid #ddd;
            text-align: center;
        }

        table th {
            background-color: #d9534f; /* Rojo */
            color: white;
        }

        table tbody tr:nth-child(even) {
            background-color: #f9f9f9;
        }

        table tbody tr:nth-child(odd) {
            background-color: #f1f1f1;
        }

        .description {
            margin-top: 40px;
            background-color: #f9f9f9;
            padding: 20px;
            border-radius: 10px;
        }

        .description h2, .description h3, .description p {
            color: #d9534f;
        }

        .totals {
            margin-top: 20px;
            text-align: center;
            font-size: 1.2rem;
            color: #fff;
            background-color: #d9534f;
            padding: 15px;
            border-radius: 10px;
        }

        /* Responsividad para dispositivos móviles */
        @media (max-width: 768px) {
            .form-group, .form-group-50 {
                flex: 1 1 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Simulador de Tarjeta de Crédito</h1>
        <form id="simulador-form">
            <div class="form-group-50" style="flex: 1 1 50%;">
                <label for="tasa">Tasa E.A. (%):</label>
                <input type="number" id="tasa" name="tasa" step="0.01" placeholder="Ej: 27.8" oninput="calcularTasaMV()">
            </div>
            <div class="form-group-50" style="flex: 1 1 50%;">
                <label for="tasaMV">Tasa M.V.:</label>
                <input type="text" id="tasaMV" name="tasaMV" readonly>
            </div>
            <div class="form-group">
                <label for="cuotas">Número de Cuotas:</label>
                <div id="cuotas-container" class="cuotas-container" onclick="focusCuotasInput()">
                    <input type="number" id="cuotas-input" name="cuotas" placeholder="Escribe un número y presiona Enter" onkeydown="handleCuotasInput(event)">
                </div>
            </div>
            <div class="form-group">
                <label for="valor">Valor de la Transacción:</label>
                <input type="number" id="valor" name="valor" placeholder="Ej: 50000">
            </div>
            <div class="form-group">
                <label for="fechaTransaccion">Fecha de Transacción:</label>
                <input type="date" id="fechaTransaccion" name="fechaTransaccion" onchange="actualizarMesCorte()">
            </div>
            <div class="form-group">
                <label for="fechaCorte">Fecha de Corte:</label>
                <input type="text" id="fechaCorte" name="fechaCorte" readonly>
            </div>
            <div class="form-group">
                <label for="fechaPago">Próxima Fecha de Pago:</label>
                <input type="text" id="fechaPago" name="fechaPago" readonly>
            </div>
            <div class="button-container">
                <button type="button" class="limpiar" onclick="limpiarFormulario()">
                    <i class="fas fa-trash"></i> Limpiar
                </button>
                <button type="button" class="simular" onclick="calcularSimulacion()">
                    <i class="fas fa-play"></i> Simular
                </button>
            </div>
        </form>

        <h2>Resultados</h2>
        <div id="resultados" class="simulation-container">
            <!-- Simulaciones se llenarán aquí -->
        </div>

        <div class="description">
            <h2>Instrucciones y Conceptos Básicos</h2>

            <h3>Cómo Usar el Simulador</h3>
            <ol>
                <li><strong>Tasa E.A. (%):</strong> Ingresa la Tasa Efectiva Anual de tu tarjeta de crédito.</li>
                <li><strong>Número de Cuotas:</strong> Añade la cantidad de cuotas que deseas simular. Escribe un número y presiona <strong>Enter</strong> para agregarlo.</li>
                <li><strong>Valor de la Transacción:</strong> Introduce el monto total de la transacción que deseas financiar.</li>
                <li><strong>Fecha de Transacción:</strong> Selecciona la fecha en que se realiza la transacción.</li>
                <li><strong>Fecha de Corte:</strong> Elige una fecha de corte.</li>
                <li><strong>Próxima Fecha de Pago:</strong> Se calculará automáticamente según la fecha de corte seleccionada.</li>
                <li>Una vez completados todos los campos, haz clic en el botón <strong>Simular</strong> para generar las cuotas.</li>
            </ol>

            <h3>Conceptos Básicos</h3>
            <ul>
                <li><strong>Tasa E.A. (Tasa Efectiva Anual):</strong> Es el interés anual que se aplica a la deuda de la tarjeta de crédito.</li>
                <li><strong>Tasa M.V. (Mensual Vencido):</strong> Es la tasa de interés mensual derivada de la Tasa E.A.</li>
                <li><strong>Abono Capital:</strong> Es la parte de la cuota que se destina a reducir el saldo principal de la deuda.</li>
                <li><strong>Intereses:</strong> Es la parte de la cuota que corresponde al costo del dinero prestado, calculado sobre el saldo pendiente.</li>
                <li><strong>Cuota Total:</strong> Es la suma del Abono Capital y los Intereses en cada período.</li>
                <li><strong>Saldo Inicial:</strong> Es el monto pendiente de pago al inicio de cada período.</li>
                <li><strong>Saldo Final:</strong> Es el monto pendiente de pago al finalizar cada período después de aplicar el pago de Cuota Total.</li>
            </ul>
        </div>
    </div>

    <!-- Flatpickr JS -->
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script>
        // Datos de fechas de corte y pago
        const fechasCortePago = {
            "2023-12-01": "2023-12-21",
            "2023-12-08": "2024-01-02",
            "2023-12-15": "2024-01-04",
            "2023-12-23": "2024-01-12",
            "2023-12-30": "2024-01-24",
            "2024-01-05": "2024-01-25",
            "2024-01-12": "2024-02-05",
            "2024-01-19": "2024-02-05",
            "2024-01-26": "2024-02-15",
            "2024-01-30": "2024-02-20",
            "2024-02-02": "2024-02-25",
            "2024-02-09": "2024-03-05",
            "2024-02-16": "2024-03-05",
            "2024-02-23": "2024-03-15",
            "2024-02-27": "2024-03-20",
            "2024-03-01": "2024-03-25",
            "2024-03-08": "2024-04-05",
            "2024-03-15": "2024-04-10",
            "2024-03-22": "2024-04-15",
            "2024-03-30": "2024-04-20",
            "2024-04-05": "2024-04-25",
            "2024-04-12": "2024-05-05",
            "2024-04-19": "2024-05-10",
            "2024-04-26": "2024-05-15",
            "2024-04-29": "2024-05-20",
            "2024-05-03": "2024-05-25",
            "2024-05-10": "2024-06-05",
            "2024-05-17": "2024-06-10",
            "2024-05-24": "2024-06-15",
            "2024-05-30": "2024-06-20",
            "2024-06-07": "2024-06-25",
            "2024-06-14": "2024-07-05",
            "2024-06-21": "2024-07-10",
            "2024-06-28": "2024-07-15",
            "2024-06-29": "2024-07-20",
            "2024-07-05": "2024-07-25",
            "2024-07-12": "2024-08-05",
            "2024-07-19": "2024-08-10",
            "2024-07-26": "2024-08-15",
            "2024-07-30": "2024-08-20",
            "2024-08-02": "2024-08-25",
            "2024-08-09": "2024-09-05",
            "2024-08-16": "2024-09-10",
            "2024-08-23": "2024-09-15",
            "2024-08-30": "2024-09-20",
            "2024-09-06": "2024-09-25",
            "2024-09-13": "2024-10-05",
            "2024-09-20": "2024-10-10",
            "2024-09-27": "2024-10-15",
            "2024-09-29": "2024-10-20",
            "2024-10-04": "2024-10-25",
            "2024-10-11": "2024-11-05",
            "2024-10-18": "2024-11-10",
            "2024-10-25": "2024-11-15",
            "2024-10-30": "2024-11-20",
            "2024-11-01": "2024-11-25",
            "2024-11-08": "2024-12-05",
            "2024-11-15": "2024-12-10",
            "2024-11-22": "2024-12-15",
            "2024-11-29": "2024-12-20",
            "2024-12-06": "2024-12-25",
            "2024-12-13": "2025-01-05",
            "2024-12-20": "2025-01-10",
            "2024-12-27": "2025-01-15",
            "2024-12-30": "2025-01-20"
        };

        // Array para almacenar las cuotas ingresadas
        let cuotasArray = [];

        document.addEventListener('DOMContentLoaded', function () {
            const fechaCortePicker = flatpickr("#fechaCorte", {
                dateFormat: "Y-m-d",
                // Permitir solo viernes o el penúltimo día del mes
                enable: [
                    function (date) {
                        const dayOfWeek = date.getDay(); // 0: domingo, 1: lunes, ..., 5: viernes
                        const lastDayOfMonth = new Date(date.getFullYear(), date.getMonth() + 1, 0);
                        const penultimoDiaMes = new Date(lastDayOfMonth);
                        penultimoDiaMes.setDate(lastDayOfMonth.getDate() - 1); // Penúltimo día del mes

                        // Permitir solo viernes o el penúltimo día del mes
                        return (dayOfWeek === 5 || date.toDateString() === penultimoDiaMes.toDateString());
                    }
                ],
                onChange: function (selectedDates, dateStr, instance) {
                    // Cuando se selecciona una fecha válida, buscar la fecha de pago correspondiente
                    if (fechasCortePago[dateStr]) {
                        document.getElementById('fechaPago').value = fechasCortePago[dateStr];
                    } else {
                        document.getElementById('fechaPago').value = "";
                    }
                }
            });

            const fechaTransaccionPicker = flatpickr("#fechaTransaccion", {
                dateFormat: "Y-m-d"
            });

            // Guardar la instancia de Flatpickr para manipulación posterior
            document.querySelector("#fechaCorte")._flatpickr = fechaCortePicker;
            document.querySelector("#fechaTransaccion")._flatpickr = fechaTransaccionPicker;
        });

        // Función para calcular la Tasa M.V. a partir de la Tasa E.A. y redondearla a 2 decimales
        function calcularTasaMV() {
            const tasaEA = parseFloat(document.getElementById("tasa").value);
            if (!isNaN(tasaEA)) {
                const tasaMV = Math.pow((1 + tasaEA / 100), 1 / 12) - 1;
                document.getElementById("tasaMV").value = (tasaMV * 100).toFixed(2) + ' %'; // Redondear a 2 decimales
            } else {
                document.getElementById("tasaMV").value = '';
            }
        }

        // Actualizar automáticamente el mes de corte al elegir la fecha de transacción
        function actualizarMesCorte() {
            const fechaTransaccionValue = document.getElementById("fechaTransaccion").value;
            if (!fechaTransaccionValue) {
                return;
            }
            const fechaTransaccion = new Date(fechaTransaccionValue);
            const flatpickrInstance = document.querySelector("#fechaCorte")._flatpickr;

            // Establecer minDate en Fecha de Corte igual a Fecha de Transacción
            flatpickrInstance.set('minDate', fechaTransaccion);

            // Encontrar el tercer viernes del mes de la fecha de transacción
            let tercerViernes = encontrarTercerViernes(fechaTransaccion.getFullYear(), fechaTransaccion.getMonth());

            // Verificar si el tercer viernes es antes de la Fecha de Transacción
            if (tercerViernes) {
                const fechaCorteTemp = new Date(tercerViernes);
                if (fechaCorteTemp < fechaTransaccion) {
                    // Si es anterior, buscar el tercer viernes del siguiente mes
                    const siguienteMes = fechaTransaccion.getMonth() + 1;
                    const siguienteAnio = siguienteMes > 11 ? fechaTransaccion.getFullYear() + 1 : fechaTransaccion.getFullYear();
                    const mes = siguienteMes > 11 ? 0 : siguienteMes;
                    tercerViernes = encontrarTercerViernes(siguienteAnio, mes);
                }
                if (tercerViernes) {
                    flatpickrInstance.setDate(tercerViernes, true);
                    console.log(`Tercer viernes encontrado: ${tercerViernes}`);
                } else {
                    console.log("No se encontró un tercer viernes en este mes.");
                }
            } else {
                console.log("No se encontró un tercer viernes en este mes.");
            }
        }

        // Función para encontrar el tercer viernes de un mes
        function encontrarTercerViernes(year, month) {
            let count = 0;
            for (let day = 1; day <= 31; day++) {
                const date = new Date(year, month, day);
                if (date.getMonth() !== month) break; // Evitar pasar al siguiente mes
                if (date.getDay() === 5) { // 5 corresponde a viernes
                    count++;
                    if (count === 3) {
                        // Formatear la fecha como YYYY-MM-DD
                        const yyyy = date.getFullYear();
                        const mm = String(date.getMonth() + 1).padStart(2, '0');
                        const dd = String(date.getDate()).padStart(2, '0');
                        return `${yyyy}-${mm}-${dd}`;
                    }
                }
            }
            return null; // No hay tercer viernes en el mes
        }

        // Función para manejar la entrada de cuotas
        function handleCuotasInput(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                const input = event.target;
                const value = parseInt(input.value.trim());

                // Validar que el valor sea un número entre 1 y 60
                if (!isNaN(value) && value >= 1 && value <= 60) {
                    // Verificar que la cuota no haya sido agregada previamente
                    if (!cuotasArray.includes(value)) {
                        cuotasArray.push(value);
                        addCuotaTag(value);
                    } else {
                        alert(`La cuota ${value} ya ha sido agregada.`);
                    }
                } else {
                    alert("Por favor, ingresa un número válido de cuotas (1-60).");
                }

                // Limpiar el input después de agregar
                input.value = '';
            }
        }

        // Función para agregar una etiqueta (tag) de cuota
        function addCuotaTag(value) {
            const cuotasContainer = document.getElementById("cuotas-container");

            // Crear el elemento de la etiqueta
            const tag = document.createElement("span");
            tag.classList.add("cuota-tag");
            tag.textContent = value;

            // Crear el botón de eliminación
            const removeBtn = document.createElement("span");
            removeBtn.classList.add("remove-tag");
            removeBtn.textContent = '✕';
            removeBtn.onclick = function () {
                cuotasContainer.removeChild(tag);
                cuotasArray = cuotasArray.filter(cuota => cuota !== value);
            };

            tag.appendChild(removeBtn);
            cuotasContainer.insertBefore(tag, document.getElementById("cuotas-input"));
        }

        // Función para enfocar el input de cuotas cuando se hace clic en el contenedor
        function focusCuotasInput() {
            document.getElementById("cuotas-input").focus();
        }

        // Función para formatear números según notación española y añadir el símbolo \$
        function formatearNumero(numero) {
            return '\$' + numero.toLocaleString('es-ES', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }

        // Función para obtener la abreviatura del mes en español sin punto
        function obtenerMesAbreviado(date) {
            const opciones = { month: 'short' };
            let mes = date.toLocaleString('es-ES', opciones);
            // Eliminar el punto si existe (e.g., "nov." -> "nov")
            if (mes.endsWith('.')) {
                mes = mes.slice(0, -1);
            }
            // Capitalizar la primera letra
            mes = mes.charAt(0).toUpperCase() + mes.slice(1);
            return mes;
        }

        // Función para verificar si una fecha es el tercer viernes del mes
        function esTercerViernes(date) {
            if (date.getDay() !== 5) return false; // 5 corresponde a viernes
            const day = date.getDate();
            let fridayCount = 0;
            for (let d = 1; d <= day; d++) {
                let currentDate = new Date(date.getFullYear(), date.getMonth(), d);
                if (currentDate.getDay() === 5) fridayCount++;
            }
            console.log(`Es el tercer viernes? ${fridayCount === 3}`);
            return fridayCount === 3;
        }

        // Función para verificar si una fecha es el penúltimo día del mes
        function esPenultimoDia(fecha) {
            const ultimoDia = new Date(fecha.getFullYear(), fecha.getMonth() + 1, 0);
            const penultimoDia = new Date(fecha.getFullYear(), fecha.getMonth() + 1, ultimoDia.getDate() - 1);
            return fecha.toDateString() === penultimoDia.toDateString();
        }

        // Función para obtener el aumento de días específico para fechas en noviembre y diciembre
        function obtenerAumentoDias(fechaCorte) {
            const aumentos = {
                // Noviembre 2024
                "2024-11-01": 3, // Primer viernes
                "2024-11-08": 6, // Segundo viernes
                "2024-11-15": 2, // Tercer viernes
                // "2024-11-22": 0, // Cuarto viernes, no necesita aumento

                // Diciembre 2024
                "2024-12-06": -2, // Primer viernes
                "2024-12-13": 2  // Segundo viernes
                // "2024-12-20": 0, // Tercer viernes, no necesita aumento
                // "2024-12-27": 0, // Cuarto viernes, no necesita aumento
                // "2024-12-30": 0  // Quinto viernes, no necesita aumento
            };

            const fechaStr = fechaCorte.toISOString().split('T')[0];
            return aumentos[fechaStr] || 0;
        }

        // Función para calcular la simulación
        function calcularSimulacion() {
            // Obtener los valores del formulario
            const tasaEA = parseFloat(document.getElementById("tasa").value); // Tasa efectiva anual
            const valorTransaccion = parseFloat(document.getElementById("valor").value);
            const fechaTransaccionStr = document.getElementById("fechaTransaccion").value;
            const fechaCorteStr = document.getElementById("fechaCorte").value;

            // Validaciones básicas
            if (isNaN(tasaEA) || isNaN(valorTransaccion) || !fechaTransaccionStr || !fechaCorteStr) {
                alert("Por favor, completa todos los campos requeridos correctamente.");
                return;
            }

            // Parsear las fechas de manera robusta
            const [transYear, transMonth, transDay] = fechaTransaccionStr.split('-').map(Number);
            const fechaTransaccion = new Date(transYear, transMonth - 1, transDay);

            const [corteYear, corteMonth, corteDay] = fechaCorteStr.split('-').map(Number);
            const fechaCorte = new Date(corteYear, corteMonth - 1, corteDay);

            if (isNaN(fechaTransaccion.getTime()) || isNaN(fechaCorte.getTime())) {
                alert("Por favor, ingresa fechas válidas.");
                return;
            }

            // **Nueva Lógica: Agregar cuota automáticamente si solo hay una cuota ingresada sin presionar Enter**
            const cuotasInputValue = document.getElementById("cuotas-input").value.trim();
            if (cuotasArray.length === 0 && cuotasInputValue !== '') {
                const value = parseInt(cuotasInputValue);
                if (!isNaN(value) && value >= 1 && value <= 60) {
                    cuotasArray.push(value);
                    addCuotaTag(value);
                    // Limpiar el input después de agregar
                    document.getElementById("cuotas-input").value = '';
                } else {
                    alert("Por favor, ingresa un número válido de cuotas (1-60).");
                    return;
                }
            }

            if (cuotasArray.length === 0) {
                alert("Por favor, agrega al menos una cuota.");
                return;
            }

            // Limpiar resultados anteriores
            const resultadosDiv = document.getElementById("resultados");
            resultadosDiv.innerHTML = "";

            // Verificar si la fecha de corte es el tercer viernes
            const esTercer = esTercerViernes(fechaCorte);
            console.log(`Fecha de Corte: ${fechaCorteStr}, ¿Es tercer viernes? ${esTercer}`);

            // Verificar si el mes es diciembre
            const esDiciembre = fechaCorte.getMonth() === 11; // Diciembre es 11 (0-based)
            console.log(`¿Es diciembre? ${esDiciembre}`);

            // Verificar si la fecha de corte está en noviembre y no es el penúltimo día
            const esNoviembre = fechaCorte.getMonth() === 10; // Noviembre es 10 (0-based)
            const penultimoDia = esPenultimoDia(fechaCorte);
            console.log(`¿Es noviembre? ${esNoviembre}, ¿Es penúltimo día? ${penultimoDia}`);

            // Obtener aumento de días específico para fechas en noviembre y diciembre
            const aumentoDias = obtenerAumentoDias(fechaCorte);
            console.log(`Aumento de días para la fecha de corte: ${aumentoDias}`);

            // Iterar sobre cada cuota ingresada
            cuotasArray.forEach(numeroCuotas => {
                // Crear contenedor para cada simulación
                const simulationDiv = document.createElement("div");
                simulationDiv.classList.add("simulation");

                // Crear título para la simulación
                const titulo = document.createElement("h3");
                titulo.textContent = `Simulación para ${numeroCuotas} Cuotas`;
                simulationDiv.appendChild(titulo);

                // Crear tabla de resultados
                const table = document.createElement("table");
                table.innerHTML = `
                    <thead>
                        <tr>
                            <th>Período</th>
                            <th>Saldo Inicial</th>
                            <th>Abono Capital</th>
                            <th>Intereses</th>
                            <th>Cuota</th>
                            <th>Saldo Final</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Resultados se llenarán aquí -->
                    </tbody>
                `;
                simulationDiv.appendChild(table);

                // Crear div para totales
                const totalsDiv = document.createElement("div");
                totalsDiv.classList.add("totals");
                simulationDiv.appendChild(totalsDiv);

                resultadosDiv.appendChild(simulationDiv);

                // Convertir la tasa efectiva anual (E.A.) a tasa mensual (M.V.)
                const tasaMensual = Math.pow((1 + tasaEA / 100), 1 / 12) - 1;

                // Calcular días transcurridos entre la fecha de transacción y la fecha de corte, incluyendo el mismo día de la transacción
                const diasHastaCorte = Math.floor((fechaCorte - fechaTransaccion) / (1000 * 60 * 60 * 24)) + 1; // Sumar 1 para incluir el día de transacción
                const diasHastaPago = 25; // Sabemos que siempre serán 25 días entre la fecha de corte y la fecha de pago

                let saldoInicial = valorTransaccion;
                let saldoFinal = saldoInicial;
                const abonoCapital = valorTransaccion / numeroCuotas; // Pago de capital constante en todas las cuotas

                const tbody = table.querySelector("tbody");
                tbody.innerHTML = ""; // Limpiar la tabla de resultados antes de empezar

                let totalIntereses = 0;
                let totalCuotas = 0;

                // Calcular primera cuota
                const interesesPrimerMes = ((saldoInicial * tasaMensual) / 30) * diasHastaCorte;
                const cuotaTotal = abonoCapital + interesesPrimerMes;
                saldoFinal = saldoInicial - abonoCapital;

                totalIntereses += interesesPrimerMes;
                totalCuotas += cuotaTotal;

                let fechaPagoSimulacion = new Date(corteYear, corteMonth - 1, corteDay);
                fechaPagoSimulacion.setDate(fechaPagoSimulacion.getDate() + 26); // Ajustamos a 26 días después de la fecha de corte

                // Obtener mes abreviado y año para la cuota 1
                const mesAbreviado = obtenerMesAbreviado(fechaPagoSimulacion);
                const año = fechaPagoSimulacion.getFullYear();
                const periodo = `Cuota 1 ${mesAbreviado} ${año}`;

                let row = `
                    <tr>
                        <td>${periodo}</td>
                        <td>${formatearNumero(saldoInicial)}</td>
                        <td>${formatearNumero(abonoCapital)}</td>
                        <td>${formatearNumero(interesesPrimerMes)}</td>
                        <td>${formatearNumero(cuotaTotal)}</td>
                        <td>${formatearNumero(saldoFinal)}</td>
                    </tr>
                `;
                tbody.innerHTML += row;

                saldoInicial = saldoFinal;

                // Calcular las cuotas restantes
                for (let mes = 2; mes <= numeroCuotas; mes++) {
                    // Ajuste: restar 2 o 4 días según si es tercer viernes o no
                    let diasInteres = esTercer ? diasHastaPago - 2 : diasHastaPago - 4; // 23 o 21 días

                    // **Nueva Lógica: Si es el tercer viernes de diciembre, restar 2 días adicionales a partir de la segunda cuota**
                    if (esTercer && esDiciembre) {
                        diasInteres -= 2;
                        console.log(`Es el tercer viernes de diciembre, días de interés ajustados a ${diasInteres}`);
                    }

                    // **Nueva Lógica: Aplicar aumento de días específico para fechas en noviembre y diciembre**
                    if (!esPenultimoDia(fechaCorte)) {
                        diasInteres += aumentoDias;
                        console.log(`Fecha de Corte: ${fechaCorteStr}, Aumento de días aplicado: ${aumentoDias}, días de interés ajustados a ${diasInteres}`);
                    }

                    console.log(`Cuota ${mes}: días de interés ajustados a ${diasInteres}`);

                    const interesesMes = saldoInicial * tasaMensual;
                    const interesesSobreCapital = ((abonoCapital * tasaMensual) / 30) * diasInteres;
                    const interesesTotales = interesesMes + interesesSobreCapital;
                    const cuotaMensual = abonoCapital + interesesTotales;

                    saldoFinal = saldoInicial - abonoCapital;

                    totalIntereses += interesesTotales;
                    totalCuotas += cuotaMensual;

                    // Calcular correctamente la fecha de pago para las cuotas siguientes
                    fechaPagoSimulacion = new Date(fechaPagoSimulacion);
                    fechaPagoSimulacion.setMonth(fechaPagoSimulacion.getMonth() + 1);

                    // Verificar si el mes ha cambiado correctamente (evitar desbordes)
                    const expectedMonth = (corteMonth - 1 + mes) % 12;
                    if (fechaPagoSimulacion.getMonth() !== expectedMonth) {
                        // Si el mes no coincide, ajustar al último día del mes
                        fechaPagoSimulacion = new Date(fechaPagoSimulacion.getFullYear(), fechaPagoSimulacion.getMonth() + 1, 0);
                    }

                    // Obtener mes abreviado y año para la cuota actual
                    const mesAbreviadoActual = obtenerMesAbreviado(fechaPagoSimulacion);
                    const añoActual = fechaPagoSimulacion.getFullYear();
                    const periodoActual = `Cuota ${mes} ${mesAbreviadoActual} ${añoActual}`;

                    row = `
                        <tr>
                            <td>${periodoActual}</td>
                            <td>${formatearNumero(saldoInicial)}</td>
                            <td>${formatearNumero(abonoCapital)}</td>
                            <td>${formatearNumero(interesesTotales)}</td>
                            <td>${formatearNumero(cuotaMensual)}</td>
                            <td>${formatearNumero(saldoFinal)}</td>
                        </tr>
                    `;
                    tbody.innerHTML += row;

                    saldoInicial = saldoFinal;
                }

                // Mostrar los totales
                totalsDiv.innerHTML = `
                    <p>Total de intereses pagados: ${formatearNumero(totalIntereses)}</p>
                    <p>Total de la sumatoria de cuotas: ${formatearNumero(totalCuotas)}</p>
                `;
            });
        }

        // Función para limpiar el formulario
        function limpiarFormulario() {
            document.getElementById("tasa").value = '';
            document.getElementById("tasaMV").value = '';
            document.getElementById("cuotas-input").value = '';
            document.getElementById("valor").value = '';
            document.getElementById("fechaTransaccion").value = '';
            document.getElementById("fechaCorte").value = '';
            document.getElementById("fechaPago").value = '';
            cuotasArray = [];
            document.getElementById("cuotas-container").innerHTML = '<input type="number" id="cuotas-input" name="cuotas" placeholder="Escribe un número y presiona Enter" onkeydown="handleCuotasInput(event)">';
            document.getElementById("resultados").innerHTML = '';
        }
    </script>
</body>
</html>
